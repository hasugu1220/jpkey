<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏùºÎ≥∏Ïñ¥ Í∞ÄÏÉÅ ÌÇ§Î≥¥Îìú v4 (ÎìúÎûòÍ∑∏ ÏûÖÎ†•)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            user-select: none;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 21px;
            width: 100%;
            max-width: 630px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 14px;
            font-size: 1.4em;
        }

        .input-section {
            margin-bottom: 20px;
        }

        .text-area {
            width: 100%;
            height: 42px;
            padding: 10.5px;
            border: 2px solid #ddd;
            border-radius: 7px;
            font-size: 12.6px;
            font-family: 'Noto Sans JP', 'Hiragino Kaku Gothic Pro', sans-serif;
            resize: vertical;
            outline: none;
            transition: border-color 0.3s;
        }

        .text-area:focus {
            border-color: #667eea;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 7px 14px;
            border: none;
            border-radius: 5.6px;
            font-size: 9.8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .keyboard-modes {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 12px 24px;
            border: 2px solid #667eea;
            border-radius: 25px;
            background: white;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .keyboard {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            position: relative;
        }

        .keyboard-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10.5px;
            margin-bottom: 10.5px;
        }

        .key {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8.4px;
            padding: 14px 10.5px;
            text-align: center;
            cursor: pointer;
            font-size: 16.8px;
            font-family: 'Noto Sans JP', sans-serif;
            transition: all 0.2s;
            min-height: 49px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            user-select: none;
            touch-action: manipulation;
        }

        .key:hover {
            background: #e3f2fd;
            border-color: #2196f3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .key.pressed {
            background: #bbdefb;
            transform: translateY(0) scale(1.05);
            border-color: #1976d2;
            box-shadow: 0 0 20px rgba(25, 118, 210, 0.4);
        }

        .key.has-variants::after {
            content: "‚ñº";
            position: absolute;
            bottom: 5px;
            right: 8px;
            font-size: 12px;
            color: #666;
        }

        .special-keys {
            display: flex;
            gap: 10.5px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .special-key {
            background: #667eea;
            color: white;
            font-weight: 600;
            min-width: 56px;
        }

        .special-key:hover {
            background: #5a6fd8;
        }

        .convert-key {
            background: #ff6b6b;
            color: white;
            font-weight: 600;
            font-size: 14px;
            min-width: 56px;
            position: relative;
        }

        .convert-key:hover {
            background: #ff5252;
        }

        .convert-key:active {
            background: #f44336;
        }

        .wide-key {
            min-width: 105px;
        }

        .hidden {
            display: none;
        }

        /* ÎìúÎûòÍ∑∏ ÏÑ†ÌÉù ÌåùÏóÖ */
        .drag-selector {
            position: absolute;
            background: white;
            border: 3px solid #667eea;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.2s ease-out;
        }

        .drag-selector.active {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        .selector-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .selector-char {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            font-size: 18px;
            font-family: 'Noto Sans JP', sans-serif;
            min-width: 40px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.1s;
        }

        .selector-char:hover,
        .selector-char.highlighted {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: scale(1.1);
        }

        .selector-char.dakuten {
            background: #ffecb3;
            border-color: #ff9800;
        }

        .selector-char.dakuten:hover,
        .selector-char.dakuten.highlighted {
            background: #ff9800;
            color: white;
        }

        .selector-char.handakuten {
            background: #e1f5fe;
            border-color: #03a9f4;
        }

        .selector-char.handakuten:hover,
        .selector-char.handakuten.highlighted {
            background: #03a9f4;
            color: white;
        }

        .selector-char.small {
            background: #f3e5f5;
            border-color: #9c27b0;
        }

        .selector-char.small:hover,
        .selector-char.small.highlighted {
            background: #9c27b0;
            color: white;
        }

        .info-text {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #666;
            text-align: center;
        }

        .last-input-highlight {
            background: #fff3cd !important;
            border-color: #ffc107 !important;
            animation: highlightPulse 1s ease-out;
        }

        @keyframes highlightPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
                max-width: 100%;
            }
            
            .keyboard-grid {
                gap: 10px;
            }
            
            .key {
                padding: 15px 10px;
                font-size: 20px;
                min-height: 60px;
            }
            
            .selector-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .selector-char {
                min-width: 35px;
                min-height: 35px;
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .keyboard-grid {
                gap: 8px;
            }
            
            .key {
                padding: 12px 8px;
                font-size: 18px;
                min-height: 50px;
            }
            
            .selector-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }
            
            .selector-char {
                min-width: 30px;
                min-height: 30px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üáØüáµ ÏùºÎ≥∏Ïñ¥ Í∞ÄÏÉÅ ÌÇ§Î≥¥Îìú v4</h1>
        
        <div class="input-section">
            <textarea id="textInput" class="text-area" placeholder="ÌÇ§Î•º Í∏∏Í≤å ÎàÑÎ•¥Í±∞ÎÇò ÎìúÎûòÍ∑∏Ìï¥ÏÑú Î¨∏ÏûêÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî! ÏÜåÎ¨∏ÏûêÎäî Î¨∏Ïûê ÏûÖÎ†• ÌõÑ ÏÜåÎ¨∏ÏûêÌÇ§ ÌÅ¥Î¶≠!"></textarea>
            <div class="controls">
                <button class="btn btn-primary" onclick="copyText()">üìã Î≥µÏÇ¨</button>
                <button class="btn btn-secondary" onclick="clearText()">üóëÔ∏è ÏßÄÏö∞Í∏∞</button>
            </div>
        </div>

        <div class="info-text">
            üí° ÏÇ¨Ïö©Î≤ï: ÌÇ§Î•º Í∏∏Í≤å ÎàÑÎ•¥Í≥† ÏûàÏúºÎ©¥ Í¥ÄÎ†® Î¨∏ÏûêÎì§Ïù¥ ÎÇòÌÉÄÎÇ©ÎãàÎã§! ÏÜåÎ¨∏ÏûêÎäî Í∏∞Î≥∏ Î¨∏Ïûê ÏûÖÎ†• ÌõÑ ÏÜåÎ¨∏ÏûêÌÇ§Î•º ÎàÑÎ•¥ÏÑ∏Ïöî.
        </div>

        <div class="keyboard-modes">
            <button class="mode-btn active" onclick="switchMode('hiragana')">„Å≤„Çâ„Åå„Å™</button>
            <button class="mode-btn" onclick="switchMode('katakana')">„Ç´„Çø„Ç´„Éä</button>
        </div>

        <!-- ÌûàÎùºÍ∞ÄÎÇò ÌÇ§Î≥¥Îìú -->
        <div id="hiragana-keyboard" class="keyboard">
            <div class="keyboard-grid">
                <div class="key has-variants" data-group="a">„ÅÇ</div>
                <div class="key has-variants" data-group="ka">„Åã</div>
                <div class="key has-variants" data-group="sa">„Åï</div>
                <div class="key has-variants" data-group="ta">„Åü</div>
                <div class="key has-variants" data-group="na">„Å™</div>
                
                <div class="key has-variants" data-group="ha">„ÅØ</div>
                <div class="key has-variants" data-group="ma">„Åæ</div>
                <div class="key has-variants" data-group="ya">„ÇÑ</div>
                <div class="key has-variants" data-group="ra">„Çâ</div>
                <div class="key has-variants" data-group="wa">„Çè</div>
            </div>
            
            <div class="special-keys">
                <div class="key special-key" onclick="insertText('„ÄÅ')">„ÄÅ</div>
                <div class="key special-key" onclick="insertText('„ÄÇ')">„ÄÇ</div>
                <div class="key special-key" onclick="insertText('„Éº')">„Éº</div>
                <div class="key convert-key" onclick="convertToSmall()">Â∞è</div>
                <div class="key special-key wide-key" onclick="insertText(' ')">„Çπ„Éö„Éº„Çπ</div>
                <div class="key special-key" onclick="backspace()">‚å´</div>
            </div>
        </div>

        <!-- Ïπ¥ÌÉÄÏπ¥ÎÇò ÌÇ§Î≥¥Îìú -->
        <div id="katakana-keyboard" class="keyboard hidden">
            <div class="keyboard-grid">
                <div class="key has-variants" data-group="A">„Ç¢</div>
                <div class="key has-variants" data-group="KA">„Ç´</div>
                <div class="key has-variants" data-group="SA">„Çµ</div>
                <div class="key has-variants" data-group="TA">„Çø</div>
                <div class="key has-variants" data-group="NA">„Éä</div>
                
                <div class="key has-variants" data-group="HA">„Éè</div>
                <div class="key has-variants" data-group="MA">„Éû</div>
                <div class="key has-variants" data-group="YA">„É§</div>
                <div class="key has-variants" data-group="RA">„É©</div>
                <div class="key has-variants" data-group="WA">„ÉØ</div>
            </div>
            
            <div class="special-keys">
                <div class="key special-key" onclick="insertText('„ÄÅ')">„ÄÅ</div>
                <div class="key special-key" onclick="insertText('„ÄÇ')">„ÄÇ</div>
                <div class="key special-key" onclick="insertText('„Éº')">„Éº</div>
                <div class="key convert-key" onclick="convertToSmall()">Â∞è</div>
                <div class="key special-key wide-key" onclick="insertText(' ')">„Çπ„Éö„Éº„Çπ</div>
                <div class="key special-key" onclick="backspace()">‚å´</div>
            </div>
        </div>
    </div>

    <!-- ÎìúÎûòÍ∑∏ ÏÑ†ÌÉùÍ∏∞ -->
    <div class="drag-selector" id="dragSelector">
        <div class="selector-grid" id="selectorGrid"></div>
    </div>

    <script>
        let currentMode = 'hiragana';
        let isPressed = false;
        let pressTimer = null;
        let currentKey = null;
        let selectorActive = false;
        let lastInputPosition = -1;
        
        // Î™®Î∞îÏùº ÎîîÎ∞îÏù¥Ïä§ Í∞êÏßÄ
        const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
        
        // Í∏∞Î≥∏ Î¨∏ÏûêÎßå Ìè¨Ìï® (ÌÉÅÏùå/Î∞òÌÉÅÏùå Ìè¨Ìï®, ÏÜåÎ¨∏ÏûêÎäî Ï†úÏô∏)
        const characterGroups = {
            'a': { chars: ['„ÅÇ', '„ÅÑ', '„ÅÜ', '„Åà', '„Åä'] },
            'ka': { chars: ['„Åã', '„Åç', '„Åè', '„Åë', '„Åì', '„Åå', '„Åé', '„Åê', '„Åí', '„Åî'] },
            'sa': { chars: ['„Åï', '„Åó', '„Åô', '„Åõ', '„Åù', '„Åñ', '„Åò', '„Åö', '„Åú', '„Åû'] },
            'ta': { chars: ['„Åü', '„Å°', '„Å§', '„Å¶', '„Å®', '„Å†', '„Å¢', '„Å•', '„Åß', '„Å©'] },
            'na': { chars: ['„Å™', '„Å´', '„Å¨', '„Å≠', '„ÅÆ'] },
            'ha': { chars: ['„ÅØ', '„Å≤', '„Åµ', '„Å∏', '„Åª', '„Å∞', '„Å≥', '„Å∂', '„Åπ', '„Åº', '„Å±', '„Å¥', '„Å∑', '„Å∫', '„ÅΩ'] },
            'ma': { chars: ['„Åæ', '„Åø', '„ÇÄ', '„ÇÅ', '„ÇÇ'] },
            'ya': { chars: ['„ÇÑ', '„ÇÜ', '„Çà'] },
            'ra': { chars: ['„Çâ', '„Çä', '„Çã', '„Çå', '„Çç'] },
            'wa': { chars: ['„Çè', '„Çê', '„Çì'] },
            'A': { chars: ['„Ç¢', '„Ç§', '„Ç¶', '„Ç®', '„Ç™'] },
            'KA': { chars: ['„Ç´', '„Ç≠', '„ÇØ', '„Ç±', '„Ç≥', '„Ç¨', '„ÇÆ', '„Ç∞', '„Ç≤', '„Ç¥'] },
            'SA': { chars: ['„Çµ', '„Ç∑', '„Çπ', '„Çª', '„ÇΩ', '„Ç∂', '„Ç∏', '„Ç∫', '„Çº', '„Çæ'] },
            'TA': { chars: ['„Çø', '„ÉÅ', '„ÉÑ', '„ÉÜ', '„Éà', '„ÉÄ', '„ÉÇ', '„ÉÖ', '„Éá', '„Éâ'] },
            'NA': { chars: ['„Éä', '„Éã', '„Éå', '„Éç', '„Éé'] },
            'HA': { chars: ['„Éè', '„Éí', '„Éï', '„Éò', '„Éõ', '„Éê', '„Éì', '„Éñ', '„Éô', '„Éú', '„Éë', '„Éî', '„Éó', '„Éö', '„Éù'] },
            'MA': { chars: ['„Éû', '„Éü', '„É†', '„É°', '„É¢'] },
            'YA': { chars: ['„É§', '„É¶', '„É®'] },
            'RA': { chars: ['„É©', '„É™', '„É´', '„É¨', '„É≠'] },
            'WA': { chars: ['„ÉØ', '„É≤', '„É≥'] }
        };

        // ÏÜåÎ¨∏Ïûê Î≥ÄÌôò Îß§Ìïë
        const toSmallMap = {
            // ÌûàÎùºÍ∞ÄÎÇò
            '„ÅÇ': '„ÅÅ', '„ÅÑ': '„ÅÉ', '„ÅÜ': '„ÅÖ', '„Åà': '„Åá', '„Åä': '„Åâ',
            '„ÇÑ': '„ÇÉ', '„ÇÜ': '„ÇÖ', '„Çà': '„Çá', '„Å§': '„Å£', '„Çè': '„Çé',
            // Ïπ¥ÌÉÄÏπ¥ÎÇò
            '„Ç¢': '„Ç°', '„Ç§': '„Ç£', '„Ç¶': '„Ç•', '„Ç®': '„Çß', '„Ç™': '„Ç©',
            '„É§': '„É£', '„É¶': '„É•', '„É®': '„Éß', '„ÉÑ': '„ÉÉ', '„ÉØ': '„ÉÆ'
        };

        function getCharClass(char) {
            const dakuten = ['„Åå', '„Åé', '„Åê', '„Åí', '„Åî', '„Åñ', '„Åò', '„Åö', '„Åú', '„Åû', '„Å†', '„Å¢', '„Å•', '„Åß', '„Å©', '„Å∞', '„Å≥', '„Å∂', '„Åπ', '„Åº', '„Ç¨', '„ÇÆ', '„Ç∞', '„Ç≤', '„Ç¥', '„Ç∂', '„Ç∏', '„Ç∫', '„Çº', '„Çæ', '„ÉÄ', '„ÉÇ', '„ÉÖ', '„Éá', '„Éâ', '„Éê', '„Éì', '„Éñ', '„Éô', '„Éú'];
            const handakuten = ['„Å±', '„Å¥', '„Å∑', '„Å∫', '„ÅΩ', '„Éë', '„Éî', '„Éó', '„Éö', '„Éù'];
            const small = ['„ÅÅ', '„ÅÉ', '„ÅÖ', '„Åá', '„Åâ', '„Å£', '„ÇÉ', '„ÇÖ', '„Çá', '„Ç°', '„Ç£', '„Ç•', '„Çß', '„Ç©', '„ÉÉ', '„É£', '„É•', '„Éß'];
            
            if (dakuten.includes(char)) return 'dakuten';
            if (handakuten.includes(char)) return 'handakuten';
            if (small.includes(char)) return 'small';
            return '';
        }

        function switchMode(mode) {
            currentMode = mode;
            document.getElementById('hiragana-keyboard').classList.add('hidden');
            document.getElementById('katakana-keyboard').classList.add('hidden');
            document.getElementById(mode + '-keyboard').classList.remove('hidden');
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function showSelector(key, groupKey) {
            const group = characterGroups[groupKey];
            if (!group) {
                return;
            }
            
            const selector = document.getElementById('dragSelector');
            const grid = document.getElementById('selectorGrid');
            
            // ÌÇ§ ÏúÑÏπò Í≥ÑÏÇ∞
            const keyRect = key.getBoundingClientRect();
            
            // ÏÑ†ÌÉùÍ∏∞ ÏúÑÏπò ÏÑ§Ï†ï (ÌÇ§ ÏúÑÏ™ΩÏóê)
            const left = keyRect.left + (keyRect.width / 2) - 100;
            const top = keyRect.top - 80;
            
            selector.style.left = Math.max(10, Math.min(left, window.innerWidth - 210)) + 'px';
            selector.style.top = Math.max(10, top) + 'px';
            
            // Î¨∏Ïûê Í∑∏Î¶¨Îìú ÏÉùÏÑ±
            grid.innerHTML = '';
            group.chars.forEach(char => {
                const charElement = document.createElement('div');
                charElement.className = 'selector-char ' + getCharClass(char);
                charElement.textContent = char;
                charElement.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Ïù¥ÎØ∏ Ï≤òÎ¶¨ÎêòÏóàÎäîÏßÄ ÌôïÏù∏
                    if (!charElement.hasAttribute('data-processed')) {
                        charElement.setAttribute('data-processed', 'true');
                        insertText(char);
                        hideSelector();
                        
                        // ÏÜçÏÑ± Ï†úÍ±∞
                        setTimeout(() => {
                            charElement.removeAttribute('data-processed');
                        }, 200);
                    }
                };
                grid.appendChild(charElement);
            });
            
            selector.classList.add('active');
            selectorActive = true;
        }

        function hideSelector() {
            const selector = document.getElementById('dragSelector');
            selector.classList.remove('active');
            selectorActive = false;
            if (currentKey) {
                currentKey.classList.remove('pressed');
                currentKey = null;
            }
        }

        function insertText(text) {
            const textarea = document.getElementById('textInput');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const before = textarea.value.substring(0, start);
            const after = textarea.value.substring(end);
            
            textarea.value = before + text + after;
            const newPosition = start + text.length;
            textarea.selectionStart = textarea.selectionEnd = newPosition;
            lastInputPosition = newPosition;
            
            // Ìè¨Ïª§Ïä§Î•º Îã§Ïãú textareaÏóê ÏÑ§Ï†ïÌïòÏó¨ Ïª§ÏÑú ÏúÑÏπò Ïú†ÏßÄ
            textarea.focus();
        }

        function convertToSmall() {
            const textarea = document.getElementById('textInput');
            const cursorPos = textarea.selectionStart;
            
            if (cursorPos > 0) {
                const text = textarea.value;
                const lastChar = text[cursorPos - 1];
                
                if (toSmallMap[lastChar]) {
                    // ÏÜåÎ¨∏ÏûêÎ°ú Î≥ÄÌôò Í∞ÄÎä•Ìïú Î¨∏ÏûêÏù∏ Í≤ΩÏö∞
                    const smallChar = toSmallMap[lastChar];
                    const before = text.substring(0, cursorPos - 1);
                    const after = text.substring(cursorPos);
                    
                    textarea.value = before + smallChar + after;
                    textarea.selectionStart = textarea.selectionEnd = cursorPos;
                    
                    // Ìè¨Ïª§Ïä§Î•º Îã§Ïãú textareaÏóê ÏÑ§Ï†ï
                    textarea.focus();
                    
                    // Î≥ÄÌôò ÏôÑÎ£å ÌîºÎìúÎ∞±
                    const convertKey = document.querySelector('.convert-key');
                    convertKey.classList.add('last-input-highlight');
                    setTimeout(() => {
                        convertKey.classList.remove('last-input-highlight');
                    }, 1000);
                } else {
                    // Î≥ÄÌôòÌï† Ïàò ÏóÜÎäî Î¨∏ÏûêÏù∏ Í≤ΩÏö∞
                    const convertKey = document.querySelector('.convert-key');
                    const originalBg = convertKey.style.background;
                    convertKey.style.background = '#f44336';
                    setTimeout(() => {
                        convertKey.style.background = originalBg;
                    }, 200);
                }
            }
        }

        function backspace() {
            const textarea = document.getElementById('textInput');
            
            // Í∞ïÏ†úÎ°ú Ìè¨Ïª§Ïä§ ÏÑ§Ï†ï ÌõÑ ÌòÑÏû¨ Ïª§ÏÑú ÏúÑÏπò Îã§Ïãú ÌôïÏù∏
            textarea.focus();
            
            // ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ ÏÇ≠Ï†ú Ï≤òÎ¶¨ (Î∏åÎùºÏö∞Ï†Ä Ï∫êÏãú Î¨∏Ï†ú Ìï¥Í≤∞)
            setTimeout(() => {
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                
                if (start > 0 || end > start) {
                    const deleteStart = start === end ? start - 1 : start;
                    const before = textarea.value.substring(0, deleteStart);
                    const after = textarea.value.substring(end);
                    textarea.value = before + after;
                    const newPosition = deleteStart;
                    textarea.selectionStart = textarea.selectionEnd = newPosition;
                    lastInputPosition = newPosition;
                    
                    // Îã§Ïãú ÌïúÎ≤à Ìè¨Ïª§Ïä§ ÏÑ§Ï†ï
                    textarea.focus();
                }
            }, 10);
        }

        function copyText() {
            const textarea = document.getElementById('textInput');
            textarea.select();
            navigator.clipboard.writeText(textarea.value).then(function() {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Î≥µÏÇ¨Îê®!';
                btn.style.background = '#4caf50';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            }).catch(function() {
                document.execCommand('copy');
            });
        }

        function clearText() {
            document.getElementById('textInput').value = '';
            lastInputPosition = -1;
        }

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        document.addEventListener('DOMContentLoaded', function() {
            const textarea = document.getElementById('textInput');
            
            if (isMobile) {
                // Î™®Î∞îÏùºÏóêÏÑú ÌÇ§Î≥¥Îìú ÏôÑÏ†Ñ ÎπÑÌôúÏÑ±Ìôî
                textarea.setAttribute('readonly', true);
                textarea.setAttribute('inputmode', 'none');
                
                // Ìè¨Ïª§Ïä§ ÏûêÏ≤¥Î•º Ï∞®Îã®
                textarea.addEventListener('focus', function(e) {
                    e.preventDefault();
                    e.target.blur();
                }, true);
                
                // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ÎèÑ Ï∞®Îã®
                textarea.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                });
                
                // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ÎèÑ Ï∞®Îã®
                textarea.addEventListener('click', function(e) {
                    e.preventDefault();
                });
                
                // Î™®Îì† ÏûÖÎ†• Í¥ÄÎ†® Ïù¥Î≤§Ìä∏ Ï∞®Îã®
                textarea.addEventListener('touchend', function(e) {
                    e.preventDefault();
                });
                
                textarea.addEventListener('input', function(e) {
                    e.preventDefault();
                });
                
            } else {
                // PCÏóêÏÑúÎäî Ï†ïÏÉÅÏ†ÅÏúºÎ°ú ÏûÖÎ†• Í∞ÄÎä•
                textarea.removeAttribute('readonly');
                textarea.removeAttribute('inputmode');
            }
            
            const keys = document.querySelectorAll('.key.has-variants');
            const allKeys = document.querySelectorAll('.key');
            
            keys.forEach(key => {
                const groupKey = key.dataset.group;
                if (!groupKey) return;
                
                // ÎßàÏö∞Ïä§ Ïù¥Î≤§Ìä∏
                key.addEventListener('mousedown', function(e) {
                    if (selectorActive) return;
                    e.preventDefault();
                    
                    isPressed = true;
                    currentKey = key;
                    key.classList.add('pressed');
                    
                    // Î°±ÌîÑÎ†àÏä§ ÌÉÄÏù¥Î®∏
                    pressTimer = setTimeout(() => {
                        if (isPressed && currentKey === key) {
                            showSelector(key, groupKey);
                        }
                    }, 300);
                });
                
                key.addEventListener('mouseup', function(e) {
                    clearTimeout(pressTimer);
                    
                    // Î°±ÌîÑÎ†àÏä§ ÏÉÅÌÉúÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞ÏóêÎßå ÏßßÏùÄ ÌÅ¥Î¶≠ Ï≤òÎ¶¨
                    if (!selectorActive && isPressed && currentKey === key) {
                        // ÏßßÏùÄ ÌÅ¥Î¶≠ - Ï≤´ Î≤àÏß∏ Î¨∏Ïûê ÏûÖÎ†•
                        const group = characterGroups[groupKey];
                        if (group && group.chars.length > 0) {
                            insertText(group.chars[0]);
                        }
                        key.classList.remove('pressed');
                        isPressed = false;
                        currentKey = null;
                    }
                });
                
                key.addEventListener('mouseleave', function(e) {
                    // Î°±ÌîÑÎ†àÏä§ ÏÉÅÌÉúÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞ÏóêÎßå Ï†ïÎ¶¨
                    if (!selectorActive) {
                        clearTimeout(pressTimer);
                        key.classList.remove('pressed');
                        if (currentKey === key) {
                            isPressed = false;
                            currentKey = null;
                        }
                    }
                });
                
                // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏
                key.addEventListener('touchstart', function(e) {
                    if (selectorActive) return;
                    e.preventDefault();
                    
                    isPressed = true;
                    currentKey = key;
                    key.classList.add('pressed');
                    
                    pressTimer = setTimeout(() => {
                        if (isPressed && currentKey === key) {
                            showSelector(key, groupKey);
                        }
                    }, 300);
                });
                
                key.addEventListener('touchend', function(e) {
                    clearTimeout(pressTimer);
                    
                    // Î°±ÌîÑÎ†àÏä§ ÏÉÅÌÉúÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞ÏóêÎßå ÏßßÏùÄ ÌÑ∞Ïπò Ï≤òÎ¶¨
                    if (!selectorActive && isPressed && currentKey === key) {
                        const group = characterGroups[groupKey];
                        if (group && group.chars.length > 0) {
                            insertText(group.chars[0]);
                        }
                        key.classList.remove('pressed');
                        isPressed = false;
                        currentKey = null;
                    }
                    
                    e.preventDefault();
                });
            });

            // Î™®Îì† ÌÇ§Ïóê ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä (ÌåùÏóÖ ÏÉÅÌÉúÏóêÏÑú Îã§Î•∏ ÌÇ§ ÌÅ¥Î¶≠Ïãú ÌåùÏóÖÎßå Îã´Í∏∞)
            allKeys.forEach(key => {
                key.addEventListener('mousedown', function(e) {
                    // ÌåùÏóÖÏù¥ ÌôúÏÑ±ÌôîÎêú ÏÉÅÌÉúÏóêÏÑú Îã§Î•∏ ÌÇ§Î•º ÌÅ¥Î¶≠ÌïòÎ©¥ ÌåùÏóÖÎßå Îã´Í∏∞ (ÏûÖÎ†• ÏóÜÏùå)
                    if (selectorActive && !key.classList.contains('pressed')) {
                        e.preventDefault();
                        e.stopPropagation();
                        hideSelector();
                        return false;
                    }
                });
                
                key.addEventListener('touchstart', function(e) {
                    // ÌåùÏóÖÏù¥ ÌôúÏÑ±ÌôîÎêú ÏÉÅÌÉúÏóêÏÑú Îã§Î•∏ ÌÇ§Î•º ÌÑ∞ÏπòÌïòÎ©¥ ÌåùÏóÖÎßå Îã´Í∏∞ (ÏûÖÎ†• ÏóÜÏùå)
                    if (selectorActive && !key.classList.contains('pressed')) {
                        e.preventDefault();
                        e.stopPropagation();
                        hideSelector();
                        return false;
                    }
                });
            });
        });

        // ÏÑ†ÌÉùÍ∏∞ Ïô∏Î∂Ä ÌÅ¥Î¶≠Ïãú Ïà®Í∏∞Í∏∞
        document.addEventListener('mousedown', function(e) {
            const selector = document.getElementById('dragSelector');
            if (selectorActive && !selector.contains(e.target) && !e.target.classList.contains('key')) {
                hideSelector();
            }
        });

        // Ï†ÑÏó≠ mouseupÏúºÎ°ú Î°±ÌîÑÎ†àÏä§ ÏÉÅÌÉúÏóêÏÑú ÏÑ†ÌÉùÍ∏∞ Îã´Í∏∞
        document.addEventListener('mouseup', function(e) {
            if (selectorActive) {
                // ÏÑ†ÌÉùÍ∏∞ ÏòÅÏó≠Ïù¥ ÏïÑÎãå Í≥≥ÏóêÏÑú mouseupÏù¥ Î∞úÏÉùÌïòÎ©¥ ÏÑ†ÌÉùÍ∏∞ Îã´Í∏∞
                const selector = document.getElementById('dragSelector');
                if (!selector.contains(e.target)) {
                    hideSelector();
                }
            }
        });

        // ÎßàÏö∞Ïä§ Ïù¥ÎèôÏúºÎ°ú Î¨∏Ïûê ÌïòÏù¥ÎùºÏù¥Ìä∏
        document.addEventListener('mousemove', function(e) {
            if (!selectorActive) return;
            
            const elements = document.elementsFromPoint(e.clientX, e.clientY);
            const charElement = elements.find(el => el.classList.contains('selector-char'));
            
            // Î™®Îì† ÌïòÏù¥ÎùºÏù¥Ìä∏ Ï†úÍ±∞
            document.querySelectorAll('.selector-char.highlighted').forEach(el => {
                el.classList.remove('highlighted');
            });
            
            // ÌòÑÏû¨ Î¨∏Ïûê ÌïòÏù¥ÎùºÏù¥Ìä∏
            if (charElement) {
                charElement.classList.add('highlighted');
            }
        });

        // ÏÑ†ÌÉùÍ∏∞ ÎÇ¥ÏóêÏÑú ÎßàÏö∞Ïä§ ÏóÖÏúºÎ°ú ÏÑ†ÌÉù ÏôÑÎ£å
        document.addEventListener('mouseup', function(e) {
            if (!selectorActive) return;
            
            const elements = document.elementsFromPoint(e.clientX, e.clientY);
            const charElement = elements.find(el => el.classList.contains('selector-char'));
            
            if (charElement && !charElement.hasAttribute('data-clicked')) {
                charElement.setAttribute('data-clicked', 'true');
                insertText(charElement.textContent);
                hideSelector();
                // data-clicked ÏÜçÏÑ± Ï†úÍ±∞
                setTimeout(() => {
                    charElement.removeAttribute('data-clicked');
                }, 100);
            }
        });

        // Î™®Î∞îÏùºÏóêÏÑú ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏Î°ú Î¨∏Ïûê ÏÑ†ÌÉù (Ï§ëÎ≥µ ÏûÖÎ†• Î∞©ÏßÄ)
        document.addEventListener('touchend', function(e) {
            if (!selectorActive) return;
            
            const elements = document.elementsFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
            const charElement = elements.find(el => el.classList.contains('selector-char'));
            
            if (charElement && !charElement.hasAttribute('data-touched')) {
                charElement.setAttribute('data-touched', 'true');
                insertText(charElement.textContent);
                hideSelector();
                // data-touched ÏÜçÏÑ± Ï†úÍ±∞
                setTimeout(() => {
                    charElement.removeAttribute('data-touched');
                }, 100);
            }
        });
    </script>
</body>
</html>